name: Security Analysis

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” TruffleHog OSS Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

      - name: ğŸ”‘ GitLeaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: ğŸ“Š Generate secrets summary
        if: always()
        run: |
          echo "## ğŸ” Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” TruffleHog Scanner" >> $GITHUB_STEP_SUMMARY
          echo "- Scanned for verified secrets in codebase" >> $GITHUB_STEP_SUMMARY
          echo "- Analyzed commit history for leaked credentials" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”‘ GitLeaks Scanner" >> $GITHUB_STEP_SUMMARY
          echo "- Performed comprehensive secret detection" >> $GITHUB_STEP_SUMMARY
          echo "- Checked for common secret patterns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Scan Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- API keys and tokens" >> $GITHUB_STEP_SUMMARY
          echo "- Database connection strings" >> $GITHUB_STEP_SUMMARY
          echo "- Private keys and certificates" >> $GITHUB_STEP_SUMMARY
          echo "- Cloud service credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Generic secrets and passwords" >> $GITHUB_STEP_SUMMARY

  security-analysis:
    name: Code Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ’¾ Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: security-venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: ğŸ“¥ Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: ğŸ“¦ Install project
        run: poetry install --no-interaction

      - name: ğŸ›¡ï¸ Security check with Bandit
        run: |
          poetry run pip install bandit[toml]
          poetry run bandit -r chainchat/ -f json -o bandit-report.json
          poetry run bandit -r chainchat/ -ll
        continue-on-error: true

      - name: ğŸ”’ Dependency security check with Safety
        run: |
          poetry run pip install safety
          poetry run safety check --json --output safety-report.json
          poetry run safety check
        continue-on-error: true

      - name: ğŸ“„ License compliance check
        run: |
          poetry run pip install pip-licenses
          poetry run pip-licenses --format=json --output-file=licenses.json
          poetry run pip-licenses --fail-on="GPL v3"
        continue-on-error: true

      - name: ğŸ“Š Generate security analysis summary
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ Security Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f bandit-report.json ]; then
            BANDIT_ISSUES=$(jq '.results | length' bandit-report.json 2>/dev/null || echo "0")
            if [ "$BANDIT_ISSUES" -eq 0 ]; then
              echo "- ğŸ›¡ï¸ **Bandit Security Scan**: âœ… No security issues found" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ğŸ›¡ï¸ **Bandit Security Scan**: âš ï¸ $BANDIT_ISSUES issues found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- ğŸ›¡ï¸ **Bandit Security Scan**: â„¹ï¸ Report not generated" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f safety-report.json ]; then
            echo "- ğŸ”’ **Safety Dependency Check**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ğŸ”’ **Safety Dependency Check**: â„¹ï¸ Report not generated" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f licenses.json ]; then
            echo "- ğŸ“„ **License Compliance**: âœ… Checked" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ğŸ“„ **License Compliance**: â„¹ï¸ Report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-analysis-reports
          path: |
            bandit-report.json
            safety-report.json
            licenses.json
          retention-days: 30

  create-issues:
    name: Create Security Issues
    runs-on: ubuntu-latest
    needs: [secret-detection, security-analysis]
    if: failure()

    steps:
      - name: ğŸš¨ Create security issue for critical findings
        uses: actions/github-script@v6
        with:
          script: |
            const title = 'ğŸš¨ Security Analysis Issues Detected';
            const body = `
            ## ğŸ”’ Security Analysis Alert

            Our automated security analysis has detected potential security issues in the repository.

            **âš ï¸ ATTENTION REQUIRED**

            **Analysis Details:**
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref }}
            - **Workflow**: ${{ github.workflow }}
            - **Run ID**: ${{ github.run_id }}
            - **Secret Detection**: ${{ needs.secret-detection.result }}
            - **Security Analysis**: ${{ needs.security-analysis.result }}

            **ğŸ”§ Next Steps:**
            1. **Review**: Check the workflow logs for specific findings
            2. **Prioritize**: Address critical and high-severity issues first
            3. **Fix**: Update code, dependencies, or configuration as needed
            4. **Verify**: Re-run the security analysis to confirm fixes
            5. **Monitor**: Set up ongoing security monitoring

            **ğŸ“‹ Analysis Coverage:**
            - ğŸ” Secret detection (TruffleHog, GitLeaks)
            - ğŸ›¡ï¸ Code security analysis (Bandit)
            - ğŸ”’ Dependency vulnerability scanning (Safety)
            - ğŸ“„ License compliance checking

            **ğŸ“Š Reports Available:**
            - Download security analysis reports from workflow artifacts
            - Check the Security tab for SARIF results
            - Review individual step logs for detailed findings

            This issue will be automatically closed when security analysis passes cleanly.
            `;

            // Check for existing security issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security', 'automated'],
              state: 'open'
            });

            // Only create a new issue if one doesn't already exist
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automated', 'analysis']
              });
            }

  summary:
    name: Security Analysis Summary
    runs-on: ubuntu-latest
    needs: [secret-detection, security-analysis]
    if: always()

    steps:
      - name: ğŸ“Š Generate comprehensive security summary
        run: |
          echo "# ğŸ›¡ï¸ Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Security Analysis Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Secret Detection | ${{ needs.secret-detection.result }} | ${{ needs.secret-detection.result == 'success' && 'âœ… No secrets detected' || 'âš ï¸ Secrets found or scan issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ›¡ï¸ Security Analysis | ${{ needs.security-analysis.result }} | ${{ needs.security-analysis.result == 'success' && 'âœ… Analysis complete' || 'âš ï¸ Issues detected' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.secret-detection.result }}" == "success" && "${{ needs.security-analysis.result }}" == "success" ]]; then
            echo "## âœ… OVERALL STATUS: SECURITY ANALYSIS CLEAN" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ **All security checks completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” Secret detection: âœ… Clean" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ›¡ï¸ Code security: âœ… Analyzed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”’ Dependencies: âœ… Checked" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“„ Licenses: âœ… Compliant" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ OVERALL STATUS: REVIEW RECOMMENDED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ” **Security analysis found items for review.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**This is informational - the pipeline continues to run.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review:" >> $GITHUB_STEP_SUMMARY
            echo "- Security analysis reports in artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- Individual step logs for details" >> $GITHUB_STEP_SUMMARY
            echo "- Address critical issues when convenient" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… Security Analysis Complete
        run: |
          echo "ğŸ›¡ï¸ Security analysis completed!"
          echo "ğŸ“Š Results:"
          echo "   Secret Detection: ${{ needs.secret-detection.result }}"
          echo "   Security Analysis: ${{ needs.security-analysis.result }}"
          echo ""
          echo "â„¹ï¸ Note: Security analysis is non-blocking and for informational purposes."
          echo "ğŸ“ Review artifacts and logs for detailed findings."
