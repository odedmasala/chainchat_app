name: CI/CD Security

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/**"
  schedule:
    - cron: "0 4 * * 3"

jobs:
  scorecard-analysis:
    name: OpenSSF Scorecard Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ğŸ” Run OpenSSF Scorecard
        uses: ossf/scorecard-action@v2.3.1
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          repo_token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload Scorecard results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: scorecard-results.sarif

      - name: ğŸ“Š Generate Scorecard summary
        if: always()
        run: |
          echo "## ğŸ” OpenSSF Scorecard Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "OpenSSF Scorecard checks your repository against security best practices:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Security Checks Include:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ **Branch Protection**: Enforced on default branch" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ‘¥ **Code Review**: Required before merging" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” **Token Permissions**: Workflow tokens properly scoped" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ **Dependencies**: Pinned and up-to-date" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ›¡ï¸ **Vulnerabilities**: No known security issues" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ·ï¸ **Signed Releases**: Cryptographically signed" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– **Automated Security**: Security policies in place" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **View detailed results in the Security tab above**" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“ Upload Scorecard artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scorecard-results
          path: scorecard-results.sarif
          retention-days: 30

  actionlint:
    name: GitHub Actions Workflow Linting
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install Actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv ./actionlint /usr/local/bin/

      - name: ğŸ” Run Actionlint on all workflows
        run: |
          echo "ğŸ” Linting GitHub Actions workflows..."
          actionlint -format '{{range $err := .}}::error file={{$err.Filepath}},line={{$err.Line}},col={{$err.Column}}::{{$err.Message}}{{end}}' .github/workflows/*.yml
        continue-on-error: true

      - name: ğŸ“Š Generate Actionlint summary
        if: always()
        run: |
          echo "## ğŸ”§ GitHub Actions Workflow Linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Actionlint validates GitHub Actions workflows for:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ› ï¸ Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **YAML Syntax**: Valid YAML structure" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ **Security Issues**: Unsafe \`run:\` commands" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ·ï¸ **Action Versions**: Pinned to specific versions" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ **Typos**: Job names, step names, action names" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— **Dependencies**: Valid job dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¯ **Contexts**: Proper use of GitHub contexts" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ›¡ï¸ **Permissions**: Explicit permission settings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" | wc -l)
          echo "ğŸ“ **Analyzed $WORKFLOW_COUNT workflow files**" >> $GITHUB_STEP_SUMMARY

  ci-security-audit:
    name: CI/CD Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Audit workflow permissions
        run: |
          echo "ğŸ” Auditing GitHub Actions workflow permissions..."
          echo "" >> workflow-permissions-audit.txt
          echo "=== WORKFLOW PERMISSIONS AUDIT ===" >> workflow-permissions-audit.txt
          echo "Date: $(date)" >> workflow-permissions-audit.txt
          echo "" >> workflow-permissions-audit.txt

          for workflow in .github/workflows/*.yml; do
            echo "ğŸ“„ Analyzing: $(basename $workflow)" >> workflow-permissions-audit.txt
            echo "----------------------------------------" >> workflow-permissions-audit.txt
            
            if grep -q "permissions:" "$workflow"; then
              echo "âœ… Permissions defined" >> workflow-permissions-audit.txt
              grep -A 10 "permissions:" "$workflow" | head -10 >> workflow-permissions-audit.txt
            else
              echo "âš ï¸  WARNING: No explicit permissions defined (defaults to all)" >> workflow-permissions-audit.txt
            fi
            echo "" >> workflow-permissions-audit.txt
          done

      - name: ğŸ”’ Check for hardcoded secrets patterns
        run: |
          echo "ğŸ” Checking workflows for potential hardcoded values..."
          echo "" >> security-patterns-audit.txt
          echo "=== SECURITY PATTERNS AUDIT ===" >> security-patterns-audit.txt
          echo "Date: $(date)" >> security-patterns-audit.txt
          echo "" >> security-patterns-audit.txt

          echo "ğŸ” Checking for potential security issues:" >> security-patterns-audit.txt
          echo "" >> security-patterns-audit.txt

          if grep -r "curl.*|.*sh" .github/workflows/; then
            echo "âš ï¸  WARNING: Found 'curl | sh' pattern (potentially unsafe)" >> security-patterns-audit.txt
          else
            echo "âœ… No 'curl | sh' patterns found" >> security-patterns-audit.txt
          fi

          if grep -r "sudo.*chmod.*777" .github/workflows/; then
            echo "âš ï¸  WARNING: Found 'chmod 777' pattern (potentially unsafe)" >> security-patterns-audit.txt
          else
            echo "âœ… No 'chmod 777' patterns found" >> security-patterns-audit.txt
          fi

          if grep -r "\${{.*github\.event\.pull_request\..*}}" .github/workflows/; then
            echo "âš ï¸  WARNING: Found PR event usage (potential injection risk)" >> security-patterns-audit.txt
          else
            echo "âœ… No direct PR event usage in run commands" >> security-patterns-audit.txt
          fi

      - name: ğŸ“Š Generate CI/CD security summary
        if: always()
        run: |
          echo "## ğŸ›¡ï¸ CI/CD Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" | wc -l)
          echo "ğŸ“Š **Audited $WORKFLOW_COUNT GitHub Actions workflows**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ” Security Audit Summary:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f workflow-permissions-audit.txt ]; then
            EXPLICIT_PERMS=$(grep -c "âœ… Permissions defined" workflow-permissions-audit.txt || echo "0")
            MISSING_PERMS=$(grep -c "âš ï¸.*No explicit permissions" workflow-permissions-audit.txt || echo "0")
            echo "- ğŸ”’ **Permissions**: $EXPLICIT_PERMS workflows with explicit permissions, $MISSING_PERMS with defaults" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f security-patterns-audit.txt ]; then
            echo "- ğŸ›¡ï¸ **Security Patterns**: Checked for unsafe patterns and injection risks" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ **Recommendations:**" >> $GITHUB_STEP_SUMMARY
          echo "- Always use explicit permissions in workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Pin action versions to specific commits or tags" >> $GITHUB_STEP_SUMMARY
          echo "- Avoid using PR event data directly in run commands" >> $GITHUB_STEP_SUMMARY
          echo "- Use environment variables for dynamic values" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload security audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-security-audit
          path: |
            workflow-permissions-audit.txt
            security-patterns-audit.txt
          retention-days: 30

  summary:
    name: CI/CD Security Summary
    runs-on: ubuntu-latest
    needs: [scorecard-analysis, actionlint, ci-security-audit]
    if: always()

    steps:
      - name: ğŸ“Š Generate comprehensive CI/CD security summary
        run: |
          echo "# ğŸ›¡ï¸ CI/CD Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Security Analysis Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” OpenSSF Scorecard | ${{ needs.scorecard-analysis.result }} | ${{ needs.scorecard-analysis.result == 'success' && 'âœ… Security practices checked' || 'âš ï¸ Issues found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ Actionlint | ${{ needs.actionlint.result }} | ${{ needs.actionlint.result == 'success' && 'âœ… Workflows validated' || 'âš ï¸ Linting issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ›¡ï¸ Security Audit | ${{ needs.ci-security-audit.result }} | ${{ needs.ci-security-audit.result == 'success' && 'âœ… Security audit complete' || 'âš ï¸ Audit issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.scorecard-analysis.result }}" == "success" && "${{ needs.actionlint.result }}" == "success" && "${{ needs.ci-security-audit.result }}" == "success" ]]; then
            echo "## âœ… OVERALL STATUS: CI/CD SECURITY VALIDATED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ **All CI/CD security checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” Security best practices: âœ… Verified" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”§ Workflow linting: âœ… Clean" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ›¡ï¸ Security audit: âœ… Compliant" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ OVERALL STATUS: ATTENTION REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ” **Some CI/CD security checks need attention.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the individual check results and:" >> $GITHUB_STEP_SUMMARY
            echo "- Address OpenSSF Scorecard recommendations" >> $GITHUB_STEP_SUMMARY
            echo "- Fix Actionlint workflow issues" >> $GITHUB_STEP_SUMMARY
            echo "- Review security audit findings" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… CI/CD Security Success
        if: ${{ needs.scorecard-analysis.result == 'success' && needs.actionlint.result == 'success' && needs.ci-security-audit.result == 'success' }}
        run: |
          echo "ğŸ‰ SUCCESS: All CI/CD security checks passed!"
          echo "âœ… OpenSSF Scorecard: COMPLIANT"
          echo "âœ… Actionlint: CLEAN"
          echo "âœ… Security Audit: VALIDATED"
          echo "ğŸ”’ Your GitHub Actions workflows are secure!"

      - name: âš ï¸ CI/CD Security Issues
        if: ${{ needs.scorecard-analysis.result != 'success' || needs.actionlint.result != 'success' || needs.ci-security-audit.result != 'success' }}
        run: |
          echo "âš ï¸ CI/CD SECURITY ISSUES DETECTED!"
          echo "ğŸ“Š Results Summary:"
          echo "   OpenSSF Scorecard: ${{ needs.scorecard-analysis.result }}"
          echo "   Actionlint: ${{ needs.actionlint.result }}"
          echo "   Security Audit: ${{ needs.ci-security-audit.result }}"
          echo ""
          echo "ğŸ” Please review the Security tab and audit reports for detailed recommendations."
          exit 1
