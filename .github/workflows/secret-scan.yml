name: Secret Scanning

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 3 * * 2"

jobs:
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” TruffleHog OSS Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: ðŸ”‘ GitLeaks Secret Scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ðŸ“Š Generate secrets summary
        if: always()
        run: |
          echo "## ðŸ” Secret Scanning Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” TruffleHog Scanner" >> $GITHUB_STEP_SUMMARY
          echo "- Scanned for verified secrets in codebase" >> $GITHUB_STEP_SUMMARY
          echo "- Analyzed commit history for leaked credentials" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”‘ GitLeaks Scanner" >> $GITHUB_STEP_SUMMARY
          echo "- Performed comprehensive secret detection" >> $GITHUB_STEP_SUMMARY
          echo "- Checked for common secret patterns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Scan Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- API keys and tokens" >> $GITHUB_STEP_SUMMARY
          echo "- Database connection strings" >> $GITHUB_STEP_SUMMARY
          echo "- Private keys and certificates" >> $GITHUB_STEP_SUMMARY
          echo "- Cloud service credentials" >> $GITHUB_STEP_SUMMARY
          echo "- Generic secrets and passwords" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Create security issue if secrets found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const title = 'ðŸš¨ Secrets Detected in Repository';
            const body = `
            ## ðŸ” Secret Detection Alert

            Our automated secret scanning has detected potential secrets or credentials in the repository.

            **âš ï¸ IMMEDIATE ACTION REQUIRED**

            **Scan Details:**
            - **Commit**: ${{ github.sha }}
            - **Branch**: ${{ github.ref }}
            - **Workflow**: ${{ github.workflow }}
            - **Run ID**: ${{ github.run_id }}

            **ðŸ”§ Remediation Steps:**
            1. **Immediate**: Rotate/revoke any exposed credentials
            2. **Review**: Check the workflow logs for specific findings
            3. **Remove**: Remove secrets from code and commit history if needed
            4. **Secure**: Use GitHub Secrets or secure vault solutions
            5. **Prevent**: Add .gitignore rules for sensitive files

            **ðŸ“‹ Best Practices:**
            - Never commit API keys, passwords, or tokens
            - Use environment variables and GitHub Secrets
            - Implement pre-commit hooks for secret detection
            - Regular security audits and secret rotation

            **ðŸ” Scanners Used:**
            - TruffleHog (verified secrets detection)
            - GitLeaks (comprehensive pattern matching)

            This issue will be automatically closed when no secrets are detected.
            `;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security', 'secrets', 'critical'],
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'secrets', 'critical', 'automated']
              });
            }

  summary:
    name: Secret Scan Summary
    runs-on: ubuntu-latest
    needs: secret-detection
    if: always()

    steps:
      - name: âœ… No Secrets Found
        if: needs.secret-detection.result == 'success'
        run: |
          echo "## âœ… Secret Scanning Complete! ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **No secrets detected in the repository!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your codebase is clean of exposed credentials." >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Secrets Detected
        if: needs.secret-detection.result != 'success'
        run: |
          echo "## ðŸš¨ SECRETS DETECTED! ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **CRITICAL: Potential secrets found in the repository**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Immediate actions required:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the scan results above" >> $GITHUB_STEP_SUMMARY
          echo "2. Rotate any exposed credentials immediately" >> $GITHUB_STEP_SUMMARY
          echo "3. Remove secrets from the codebase" >> $GITHUB_STEP_SUMMARY
          echo "4. Implement proper secret management" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.secret-detection.result }}" >> $GITHUB_STEP_SUMMARY
          exit 1
