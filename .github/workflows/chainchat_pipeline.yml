name: ChainChat Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  code-quality:
    name: Code Quality & Testing
    uses: ./.github/workflows/code-quality.yml
    secrets: inherit

  security-scan:
    name: Security Analysis
    uses: ./.github/workflows/security-scan.yml
    secrets: inherit

  vulnerability-scan:
    name: Vulnerability Scanning
    uses: ./.github/workflows/vulnerability-scan.yml
    secrets: inherit

  secret-scan:
    name: Secret Detection
    uses: ./.github/workflows/secret-scan.yml
    secrets: inherit

  ci-security:
    name: CI/CD Security
    uses: ./.github/workflows/ci-security.yml
    secrets: inherit

  docker-security:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Build and scan Docker image
        run: |
          if [ -f Dockerfile ]; then
            echo "ğŸ”¨ Building Docker image..."
            docker build -t chainchat-app:latest .
            
            echo "ğŸ” Scanning Docker image for vulnerabilities..."
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
              aquasec/trivy image chainchat-app:latest
          else
            echo "âš ï¸ No Dockerfile found, skipping Docker security scan"
          fi

  final-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      [
        code-quality,
        security-scan,
        vulnerability-scan,
        secret-scan,
        ci-security,
        docker-security,
      ]
    if: always()

    steps:
      - name: ğŸ“Š Generate comprehensive summary
        run: |
          echo "# ğŸ›¡ï¸ Security Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Pipeline Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Code Quality & Testing | ${{ needs.code-quality.result }} | ${{ needs.code-quality.result == 'success' && 'âœ… Unit & Integration tests passed' || 'âŒ Tests or quality checks failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ›¡ï¸ Security Analysis | ${{ needs.security-scan.result }} | ${{ needs.security-scan.result == 'success' && 'âœ… No security issues' || 'âš ï¸ Attention required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Vulnerability Scanning | ${{ needs.vulnerability-scan.result }} | ${{ needs.vulnerability-scan.result == 'success' && 'âœ… No vulnerabilities' || 'âš ï¸ Issues found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Secret Detection | ${{ needs.secret-scan.result }} | ${{ needs.secret-scan.result == 'success' && 'âœ… No secrets found' || 'ğŸš¨ Secrets detected' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ CI/CD Security | ${{ needs.ci-security.result }} | ${{ needs.ci-security.result == 'success' && 'âœ… Workflows secure' || 'âš ï¸ Issues found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Docker Security | ${{ needs.docker-security.result }} | ${{ needs.docker-security.result == 'success' && 'âœ… Docker secure' || needs.docker-security.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Issues found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.code-quality.result }}" == "success" && "${{ needs.security-scan.result }}" == "success" && "${{ needs.vulnerability-scan.result }}" == "success" && "${{ needs.secret-scan.result }}" == "success" && "${{ needs.ci-security.result }}" == "success" ]]; then
            echo "## âœ… OVERALL STATUS: SECURE & READY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ **All security checks passed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ§ª Unit & Integration tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ¨ Code quality checks: âœ… Passed" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ›¡ï¸ Security analysis: âœ… Clean" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” Vulnerability scanning: âœ… Secure" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” Secret detection: âœ… No leaks" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”§ CI/CD security: âœ… Validated" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¦ Dependencies: âœ… Safe" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ OVERALL STATUS: ATTENTION REQUIRED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ” **Some security checks require attention.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the individual workflow results and address any issues found." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“‹ **Review Guidelines:**" >> $GITHUB_STEP_SUMMARY
            echo "- Check each failed/warning component above" >> $GITHUB_STEP_SUMMARY
            echo "- Download and review security reports from artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- Address critical and high-severity issues first" >> $GITHUB_STEP_SUMMARY
            echo "- Re-run the pipeline after fixes" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… Success notification
        if: ${{ needs.code-quality.result == 'success' && needs.security-scan.result == 'success' && needs.vulnerability-scan.result == 'success' && needs.secret-scan.result == 'success' && needs.ci-security.result == 'success' }}
        run: |
          echo "ğŸ‰ SUCCESS: All security pipeline checks passed!"
          echo "âœ… Unit & Integration Tests: PASSED"
          echo "âœ… Code Quality: PASSED"
          echo "âœ… Security Analysis: CLEAN"  
          echo "âœ… Vulnerability Scan: SECURE"
          echo "âœ… Secret Detection: NO LEAKS"
          echo "âœ… CI/CD Security: VALIDATED"
          echo "ğŸš€ Repository is secure and ready for deployment!"

      - name: âŒ Failure notification
        if: ${{ needs.code-quality.result != 'success' || needs.security-scan.result != 'success' || needs.vulnerability-scan.result != 'success' || needs.secret-scan.result != 'success' || needs.ci-security.result != 'success' }}
        run: |
          echo "âš ï¸ PIPELINE FAILED: Security issues detected!"
          echo "ğŸ“Š Results Summary:"
          echo "   Code Quality: ${{ needs.code-quality.result }}"
          echo "   Security Scan: ${{ needs.security-scan.result }}"
          echo "   Vulnerability Scan: ${{ needs.vulnerability-scan.result }}"
          echo "   Secret Detection: ${{ needs.secret-scan.result }}"
          echo "   CI/CD Security: ${{ needs.ci-security.result }}"
          echo ""
          echo "ğŸ” Please review the individual workflow logs and address issues before proceeding."
          exit 1
